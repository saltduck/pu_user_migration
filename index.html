<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Migration</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        #log { width: 100%; height: 400px; border: 1px solid #ccc; padding: 1em; overflow-y: scroll; white-space: pre-wrap; background-color: #f0f0f0; }
        button { font-size: 1.2em; padding: 0.5em 1em; margin-bottom: 1em; cursor: pointer; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
    </style>
</head>
<body>
    <h1>User Migration</h1>
    <button id="connectButton">Connect Wallet</button>
    <button id="migrateButton" disabled>Migrate All</button>
    <textarea id="log" readonly></textarea>

    <!-- Ethers.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.14.4/ethers.umd.min.js" type="application/javascript"></script>
    
    <!-- Migration Scripts -->
    <script src="./dist/bundle.js"></script>

    <!-- Frontend Logic -->
    <script>
        const log = document.getElementById('log');
        const connectButton = document.getElementById('connectButton');
        const migrateButton = document.getElementById('migrateButton');

        // Override console.log and console.error to write to the textarea
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        console.log = (...args) => {
            originalConsoleLog(...args);
            log.value += args.join(' ') + '\n';
            log.scrollTop = log.scrollHeight;
        };
        console.error = (...args) => {
            originalConsoleError(...args);
            log.value += 'ERROR: ' + args.join(' ') + '\n';
            log.scrollTop = log.scrollHeight;
        };

        let signer;

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                return console.error('MetaMask is not installed!');
            }
            try {
                const provider = new ethers.BrowserProvider(window.ethereum)
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                const network = await provider.getNetwork();
                console.log('Connected to network:', network.name, '(Chain ID:', network.chainId + ')');
                console.log('Connected with address:', address);
                connectButton.textContent = 'Connected';
                connectButton.disabled = true;
                migrateButton.disabled = false;
            } catch (error) {
                console.error('Failed to connect wallet:', error);
            }
        });

        migrateButton.addEventListener('click', async () => {
            if (!signer) {
                return console.error('Please connect your wallet first.');
            }
            migrateButton.disabled = true;
            try {
                // Access the migration functions from the global window object
                await window.migration.migrate(signer);
            } catch (error) {
                console.error('Migration failed:', error);
            }
            migrateButton.disabled = false;
        });
    </script>
</body>
</html>